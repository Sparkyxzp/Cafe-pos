<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£ - Cafe POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Kanit', sans-serif; height: 100vh; overflow: hidden; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        /* Modal Animation */
        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .modal-box { animation: popIn 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28); }

        /* =========================================
           ‚òï NEW COFFEE LOADER (Uiverse.io)
           ========================================= */
        .loader-overlay {
            position: fixed; inset: 0; z-index: 9999;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
        }

        .loader {
            width: 100px;
            height: 100px;
            position: relative;
            animation: shake 3s infinite ease-in-out;
        }

        .cup {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 30px;
            background-color: #5b4022cb;
            border: 1px solid #2e2e2e;
            border-radius: 3px 3px 10px 10px;
            z-index: 1;
            animation: cupPulse 6s infinite ease-in-out;
        }

        .cup::before {
            content: "";
            position: absolute;
            bottom: -5px;
            width: calc(100% - 2px);
            height: 6px;
            background: #5b4022cb;
            border: 1px solid #2e2e2e;
            border-top: none;
            border-radius: 50%;
            z-index: -1;
            animation: cupPulse 6s infinite ease-in-out;
        }

        .cup::after {
            content: "";
            position: absolute;
            top: -2px;
            left: 1px;
            width: calc(100% - 2px);
            height: 4px;
            background: #da8920ca;
            border: 1px solid #2e2e2e;
            border-radius: 50%;
            animation: coffeeGlow 6s infinite ease-in-out;
        }

        .cup-handle {
            position: absolute;
            top: 5px;
            right: -10px;
            width: 10px;
            height: 15px;
            border: 2px solid #2e2e2e;
            border-left: none;
            border-radius: 0 10px 10px 0;
            background: transparent;
        }

        .smoke {
            position: absolute;
            bottom: 100%;
            left: 50%;
            width: 10px;
            height: 25px;
            background: rgba(72, 67, 67, 0.501);
            border-radius: 50%;
            transform: translateX(-50%);
            animation: rise 3s infinite ease-in-out;
            filter: blur(8px);
        }

        .smoke.one { animation-delay: 0s; }
        .smoke.two { animation-delay: 0.8s; }
        .smoke.three { animation-delay: 1.6s; }

        .load {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: #2e2e2e;
            opacity: 0.6;
            font-weight: bold;
            width: 150px;
            text-align: center;
        }

        @keyframes rise {
            0% { transform: translate(-50%, 0) scale(0.4); opacity: 0; }
            30% { opacity: 0.7; }
            60% { opacity: 0.4; }
            100% { transform: translate(-50%, -120px) scale(1); opacity: 0; }
        }

        @keyframes shake {
            0% { transform: translateX(0) translateY(0) rotate(0); }
            25% { transform: translateX(-4px) translateY(-2px) rotate(-2deg); }
            50% { transform: translateX(0) translateY(0) rotate(0); }
            75% { transform: translateX(4px) translateY(-2px) rotate(2deg); }
            100% { transform: translateX(0) translateY(0) rotate(0); }
        }

        @keyframes cupPulse {
            0%, 100% { background-color: #5b4022cb; }
            50% { background-color: #f5f5f5bd; }
        }

        @keyframes coffeeGlow {
            0%, 100% { background: #da8920ca; }
            50% { background: #fed197d5; }
        }
    </style>
</head>
<body class="bg-gray-100 flex text-gray-800">

    <div id="app" class="w-full h-full flex">
        
        <div v-if="isLoggingOut" class="loader-overlay">
            <div class="loader">
                <div class="cup">
                    <div class="cup-handle"></div>
                    <div class="smoke one"></div>
                    <div class="smoke two"></div>
                    <div class="smoke three"></div>
                </div>
                <div class="load">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö...</div>
            </div>
        </div>

        <div v-if="selectedProduct" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4" @click.self="closeProductModal">
            <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden modal-box flex flex-col max-h-[90vh]" @click.stop>
                <div class="h-56 bg-gray-100 flex items-center justify-center relative">
                    <img v-if="selectedProduct.icon.startsWith('/')" :src="'http://localhost:3000' + selectedProduct.icon" class="w-full h-full object-cover">
                    <span v-else class="text-8xl">{{ selectedProduct.icon }}</span>
                    <button @click="closeProductModal" class="absolute top-4 right-4 bg-white/80 hover:bg-white text-gray-800 rounded-full w-8 h-8 flex items-center justify-center font-bold shadow transition">‚úï</button>
                </div>
                <div class="p-6 flex-1 overflow-y-auto">
                    <div class="flex justify-between items-start mb-2">
                        <h2 class="text-2xl font-bold text-gray-800">{{ selectedProduct.name }}</h2>
                        <span class="text-2xl font-bold text-orange-600">{{ selectedProduct.price }}.-</span>
                    </div>
                    <p class="text-gray-400 text-sm mb-6">{{ selectedProduct.category_name || '‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥' }}</p>
                    <div v-if="selectedProduct.has_sweetness" class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-2">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ß‡∏≤‡∏ô</label>
                        <div class="grid grid-cols-5 gap-2">
                            <button v-for="level in ['100%', '80%', '50%', '20%', '0%']" 
                                @click="tempSweetness = level"
                                class="py-2 rounded-lg border text-[10px] md:text-xs font-bold transition flex flex-col items-center justify-center gap-1"
                                :class="tempSweetness === level ? 'border-orange-500 bg-orange-50 text-orange-600 ring-2 ring-orange-200 shadow-sm' : 'border-gray-200 text-gray-500 hover:border-orange-300 hover:bg-orange-50/50'">
                                <span>{{ level }}</span>
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center justify-between bg-gray-50 rounded-xl p-3 border border-gray-100 mb-4">
                        <span class="font-bold text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</span>
                        <div class="flex items-center gap-4">
                            <button @click="tempQty > 1 ? tempQty-- : null" class="w-8 h-8 rounded-full bg-white shadow text-orange-600 font-bold hover:bg-orange-50 disabled:opacity-50 transition" :disabled="tempQty <= 1">-</button>
                            <span class="text-xl font-bold w-6 text-center">{{ tempQty }}</span>
                            <button @click="tempQty++" class="w-8 h-8 rounded-full bg-orange-500 shadow text-white font-bold hover:bg-orange-600 transition">+</button>
                        </div>
                    </div>
                </div>
                <div class="p-4 border-t bg-white">
                    <button @click="confirmAddToCart" class="w-full bg-gray-900 hover:bg-black text-white py-3.5 rounded-xl font-bold text-lg shadow-lg transition transform active:scale-95 flex justify-between px-6">
                        <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</span>
                        <span>{{ (selectedProduct.price * tempQty).toLocaleString() }}.-</span>
                    </button>
                </div>
            </div>
        </div>

        <div v-if="showSuccessModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
            <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-sm text-center modal-box relative" @click.stop>
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-4xl">‚úÖ</span>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">‡∏™‡∏±‡πà‡∏á‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h2>
                <div class="bg-green-50 rounded-xl p-4 my-4 border-2 border-dashed border-green-200">
                    <div class="text-sm text-gray-500 font-bold uppercase tracking-wider">Queue Number</div>
                    <div class="text-6xl font-extrabold text-green-600 mt-2">#{{ currentQueue }}</div>
                </div>
                <p class="text-gray-400 text-sm">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥...</p>
            </div>
        </div>

        <div class="w-full md:w-3/4 flex flex-col h-full border-r border-gray-200 bg-white">
            <div class="p-4 border-b flex justify-between items-center bg-white shadow-sm z-10 sticky top-0">
                <div>
                    <h1 class="text-2xl font-extrabold text-gray-800 tracking-tight">‚òï Cafe <span class="text-orange-500">POS</span></h1>
                    <p class="text-xs text-gray-400">‡∏™‡∏±‡πà‡∏á‡∏á‡πà‡∏≤‡∏¢ ‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß ‡∏ó‡∏±‡∏ô‡πÉ‡∏à</p>
                </div>
                <button @click="logout" class="text-red-500 hover:bg-red-50 px-3 py-1.5 rounded-lg text-xs font-bold border border-red-100 transition">
                    ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </div>
            <div class="p-3 bg-gray-50 border-b flex gap-2 overflow-x-auto whitespace-nowrap">
                <button @click="selectedCat = 'all'" class="px-5 py-2 rounded-full text-sm font-bold transition shadow-sm border" :class="selectedCat === 'all' ? 'bg-orange-500 text-white border-orange-500' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-100'">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                <button v-for="c in categories" :key="c.id" @click="selectedCat = c.id" class="px-5 py-2 rounded-full text-sm font-bold transition shadow-sm border" :class="selectedCat === c.id ? 'bg-orange-500 text-white border-orange-500' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-100'">{{ c.name }}</button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 bg-gray-100">
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 pb-20">
                    <div v-for="p in filteredProducts" :key="p.id" @click="openProductModal(p)" class="bg-white rounded-2xl shadow-sm hover:shadow-lg transition p-3 flex flex-col cursor-pointer group border border-transparent hover:border-orange-200 hover:-translate-y-1 duration-200">
                        <div class="h-36 bg-gray-50 rounded-xl mb-3 flex items-center justify-center overflow-hidden relative">
                            <img v-if="p.icon.startsWith('/')" :src="'http://localhost:3000' + p.icon" class="w-full h-full object-cover group-hover:scale-110 transition duration-500">
                            <span v-else class="text-5xl group-hover:scale-110 transition">{{ p.icon }}</span>
                            <div v-if="p.has_sweetness" class="absolute top-2 right-2 bg-white/90 backdrop-blur text-orange-600 text-[10px] px-2 py-1 rounded-full font-bold shadow-sm border border-orange-100">üç¨ ‡∏õ‡∏£‡∏±‡∏ö‡∏´‡∏ß‡∏≤‡∏ô</div>
                        </div>
                        <h3 class="font-bold text-gray-800 text-sm mb-1 line-clamp-2 leading-tight h-10">{{ p.name }}</h3>
                        <div class="mt-auto flex justify-between items-end border-t border-dashed border-gray-100 pt-2">
                            <div class="text-orange-600 font-extrabold text-lg">{{ p.price }}.-</div>
                            <div class="bg-gray-900 text-white w-7 h-7 rounded-lg flex items-center justify-center text-sm font-bold shadow-md group-hover:bg-orange-500 transition">+</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="hidden md:flex w-1/4 bg-white flex-col h-full shadow-xl z-20 border-l border-gray-200">
            <div class="p-5 bg-gray-900 text-white shadow-md">
                <h2 class="text-lg font-bold flex items-center justify-between">
                    <span>üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</span>
                    <span class="bg-orange-500 text-white text-xs px-2 py-1 rounded-full font-bold">{{ totalItems }}</span>
                </h2>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
                <div v-if="cart.length === 0" class="flex flex-col items-center justify-center h-full text-gray-400 opacity-60">
                    <span class="text-6xl mb-4">üßæ</span>
                    <p class="text-sm font-medium">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏≤‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢</p>
                </div>
                <div v-for="(item, index) in cart" :key="index" class="bg-white p-3 rounded-xl shadow-sm border border-gray-200 flex flex-col gap-2 group hover:border-orange-200 transition">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-bold text-gray-800 text-sm line-clamp-1">{{ item.name }}</div>
                            <div v-if="item.sweetness" class="text-[10px] text-orange-600 bg-orange-50 inline-block px-1.5 py-0.5 rounded mt-1 border border-orange-100">‡∏´‡∏ß‡∏≤‡∏ô: {{ item.sweetness }}</div>
                        </div>
                        <div class="font-bold text-gray-700">{{ item.price * item.qty }}.-</div>
                    </div>
                    <div class="flex justify-between items-center mt-1 pt-2 border-t border-dashed border-gray-100">
                        <div class="text-[10px] text-gray-400">@ {{ item.price }}</div>
                        <div class="flex items-center gap-2 bg-gray-100 rounded-lg p-0.5">
                            <button @click="decreaseQty(index)" class="w-6 h-6 bg-white rounded shadow-sm text-gray-600 font-bold hover:text-red-500 hover:bg-red-50 transition">-</button>
                            <span class="text-sm font-bold w-5 text-center">{{ item.qty }}</span>
                            <button @click="increaseQty(index)" class="w-6 h-6 bg-orange-500 rounded shadow-sm text-white font-bold hover:bg-orange-600 transition">+</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-5 bg-white border-t border-gray-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-gray-500 text-sm font-bold">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</span>
                    <span class="text-3xl font-extrabold text-orange-600">{{ totalAmount.toLocaleString() }}.-</span>
                </div>
                <button type="button" @click="processOrder" :disabled="cart.length === 0" 
                    class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 disabled:from-gray-300 disabled:to-gray-400 disabled:cursor-not-allowed text-white font-bold py-4 rounded-xl shadow-lg shadow-green-200 transition transform active:scale-95 flex justify-center items-center gap-2">
                    <span>üí∏</span> ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
                </button>
            </div>
        </div>

    </div>

    <script>
        const { createApp } = Vue
        createApp({
            data() {
                return {
                    categories: [], products: [], cart: [], selectedCat: 'all',
                    selectedProduct: null, tempQty: 1, tempSweetness: '100%',
                    showSuccessModal: false, currentQueue: 0, isLoggingOut: false,
                    updateTimer: null
                }
            },
            computed: {
                filteredProducts() {
                    if (this.selectedCat === 'all') return this.products;
                    return this.products.filter(p => p.category_id === this.selectedCat);
                },
                totalItems() { return this.cart.reduce((sum, i) => sum + i.qty, 0); },
                totalAmount() { return this.cart.reduce((sum, i) => sum + (Number(i.price) * i.qty), 0); }
            },
            methods: {
                async loadData() {
                    if (this.showSuccessModal || this.selectedProduct) return;
                    try {
                        const [c, p] = await Promise.all([
                            fetch('http://localhost:3000/categories').then(r => r.json()),
                            fetch('http://localhost:3000/products').then(r => r.json())
                        ]);
                        this.categories = c;
                        this.products = p; 
                    } catch (e) { console.error("API Error"); }
                },
                openProductModal(product) {
                    this.selectedProduct = product;
                    this.tempQty = 1; this.tempSweetness = '100%';
                },
                closeProductModal() {
                    this.selectedProduct = null;
                },
                confirmAddToCart() {
                    if(!this.selectedProduct) return;
                    const sweetness = this.selectedProduct.has_sweetness ? this.tempSweetness : null;
                    const existing = this.cart.find(i => i.id === this.selectedProduct.id && i.sweetness === sweetness);
                    if (existing) existing.qty += this.tempQty;
                    else this.cart.push({
                        id: this.selectedProduct.id, name: this.selectedProduct.name, price: this.selectedProduct.price,
                        qty: this.tempQty, sweetness: sweetness
                    });
                    this.closeProductModal();
                },
                increaseQty(index) { this.cart[index].qty++; },
                decreaseQty(index) { this.cart[index].qty--; if (this.cart[index].qty <= 0) this.cart.splice(index, 1); },
                
                async processOrder() {
                    if (this.cart.length === 0) return;
                    const payload = { items: this.cart, total: Number(this.totalAmount) };
                    try {
                        const res = await fetch('http://localhost:3000/orders', {
                            method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                        });
                        const result = await res.json();
                        if (result.success) {
                            if (this.updateTimer) clearInterval(this.updateTimer);
                            this.currentQueue = result.id;
                            this.showSuccessModal = true; 
                            this.cart = [];
                            setTimeout(() => {
                                this.showSuccessModal = false;
                                this.loadData();
                                this.updateTimer = setInterval(this.loadData, 5000);
                            }, 2000);
                        }
                    } catch (e) { alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠"); }
                },
                
                logout() {
                    this.isLoggingOut = true;
                    setTimeout(() => { window.location.href = 'login.html'; }, 1500);
                }
            },
            mounted() {
                this.loadData();
                this.updateTimer = setInterval(this.loadData, 5000);
            }
        }).mount('#app')
    </script>
</body>
</html>